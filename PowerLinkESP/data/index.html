<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name='viewport' content='width=device-width, initial-scale=1.0'>
	<link rel="shortcut icon"
		href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAABbUlEQVR4nGNgGLQgPTniaFdzzn0Q7mzMeRAVHrCOaM0uLi78cyaVP/r/ZvN/EL58ZMbvqHD/KEL6GF1dXcVAjNBQ//Brx2f/hRkwoaPgtoWFBSdIzsbGRhSkFkOzvb19i5OTkxaIk5UWsfzPy41gzSBclBe/DaYQpAakFtkQRpCAo6OjMUygqSr9BEzz48uL/keFB5zJyYyZnZwQlgI1RM/e3r6DgYGBicHBwaHZ0dFRH6bZzc1NaOGMyicwA2B49YKGl7GxQV4wdSA9IL0M6AbY2tpKJscFL0+JD11RXZr8GBqI31ITw5uR/Qw3gIGBgRFqCNwLUIMU1y1ufPXu7sr/WakRm5DlQF5wcHBoB3sBWyCCQFJ8cNuL60v/lxUmnnN1deWGidvb2+ugByIMMEKjCAwqihP3TegouO/r66sNV8HAwACNagzNDGiKuKPDA94lxoXF4VWICwT5+4THRQfPIUszCICiEjmAaAoAQJWqDvqsE2oAAAAASUVORK5CYII=" />
	<title>Voltage and Current Monitor</title>
	<style>
		body {
			background-color: black;
			color: #e88504;
			font-family: monospace;
		}

		h1 {
			color: #e88504;
			margin: 2rem;
			font-family: monospace;
		}

		.container {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
			grid-gap: 20px;
			padding: 20px;
		}

		canvas {
			max-width: 100%;
			height: auto;
		}

		.menu {
			position: absolute;
			top: 1rem;
			right: 1rem;
			list-style-type: none;
			padding: 0;
			margin: 0;
		}

		.menu li {
			display: inline;
			margin: 0 0.1rem;
		}

		.menu li a {
			color: white;
			text-decoration: none;
			border: 1px solid #e88504;
			padding: 5px 10px;
			border-radius: 5px;
		}

		.menu li a:hover {
			background-color: #e88504;
			color: white;
		}

		.chart-box {
			text-align: center;
			padding: 20px;
			border: 3px solid #e88504;
			border-radius: 1rem;
			color: #e88504;
			background: white;
		}

		#top-dashboard {
			text-align: center;
			padding: 35px 0 0 0;
			margin-bottom: 1rem;
		}

		#voltageChart,
		#currentChart,
		#combinedChart,
		#powerChart,
		#combinedChart2 {
			background-color: white;
			border-radius: 1rem;
		}

		.dash-panel {
			border: 2px solid #e88504;
			margin: 0.5rem;
			border-radius: 1rem;
			background-color: #382e26;
		}

		.tooltip {
			display: flex;
			align-items: center;
			justify-content: center;
			position: relative;
			text-align: center;
		}

		.tooltip .tooltiptext {
			visibility: hidden;
			width: 120px;
			background-color: #e88504;
			color: #fff;
			text-align: center;
			border-radius: 6px;
			padding: 8px 2px;
			position: absolute;
			z-index: 1;
			bottom: 100%;
			left: 50%;
			margin-left: -60px;
			border: 1px solid black;
			font-family: monospace;
		}

		.tooltip .tooltiptext::after {
			content: "";
			position: absolute;
			top: 100%;
			left: 50%;
			margin-left: -5px;
			border-width: 5px;
			border-style: solid;
			border-color: #e88504 transparent transparent transparent;
		}

		.tooltip:hover .tooltiptext {
			visibility: visible;
		}

		.input-minutes,
		.button {
			margin: 10px;
			padding: 5px;
			border-radius: 5px;
			border: 2px solid #e88504;
			flex: 1;
			max-width: 100px;
			font-family: monospace;
		}

		.button {
			background-color: black;
			color: white;
			text-decoration: none;
			border: 1px solid #e88504;
			padding: 5px 10px;
			border-radius: 5px;
			cursor: pointer;
		}

		.button:hover {
			background-color: #e88504;
			color: white;
		}

		.button:active {
			background-color: #ec9006;
			box-shadow: 0 1px #ec9006;
			transform: translateY(1px);
		}
		
		.button:disabled {
			background-color: #ccc; /* Light gray background */
			color: #666; /* Darker gray text */
			cursor: not-allowed; /* Change cursor to indicate it's not clickable */
		}

		.button.chart-config {
			margin-top: 2rem;
		}

		.wrapper {
			min-height: 100%;
			height: calc(100vh + 18rem);
			position: relative;
			text-align: center;
		}

		#bottom-bar {
			width: 70%;
			background-color: #382e26;
			position: fixed;
			bottom: 0;
			margin: 0px 12%;
			border-top-left-radius: 1rem;
			border-top-right-radius: 1rem;
			border-top: 2px solid #e88504;
			border-right: 2px solid #e88504;
			border-left: 2px solid #e88504;
			visibility: hidden;
			/* Initially hidden */
			opacity: 0;
			transition: visibility 1s, opacity 0.5s linear;
		}

		.bottom-bar-element {
			width: 33%;
			display: inline-block;
			float: left;
			text-align: center;
			padding-top: 16px;
			padding-bottom: 16px;
			color: white;
			transition: all 0.5s cubic-bezier(.25, .8, .25, 1);
			font-size: large;
		}

		/* Style the tab */
		.tab {
			overflow: hidden;
			margin: 0.5rem;
			border-radius: 0.8rem;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		/* Style the buttons inside the tab */
		.tab button {
			background-color: inherit;
			float: left;
			border: none;
			outline: none;
			cursor: pointer;
			padding: 14px 16px;
			transition: 0.3s;
			color: white;
			border: 2px solid #e88504;
			background-color: #382e26;
			border-radius: 0.5rem;
			margin: 0.3rem;
			font-family: monospace;
		}

		/* Change background color of buttons on hover */
		.tab button:hover {
			background-color: #e88504b3;
		}

		/* Create an active/current tablink class */
		.tab button.active {
			background-color: #e88504;
		}

		.charts-config-box {
			border: 2px solid;
			background-color: #382e26;
			padding: 20px;
			border-radius: 10px;
		}

		/* Style the tab content */
		.tabcontent.charts-config {
			padding: 10px;
			/* width: 50%; */
			text-align: center;
			display: flex;
			justify-content: center;
		}

		.indicator {
			display: none;
			font-weight: bold;
			position: absolute;
			border: 2px solid transparent;
			border-radius: 5px;
			padding: 5px;
		}

		.alert {
			padding: 20px;
			background-color: #f44336;
			color: white;
			opacity: 1;
			transition: opacity 0.6s;
			margin: 10px;
			border-radius: 10px;
			border: 2px solid #e88504;
			text-align: center;
		}

		.alert.voltage {
			background-color: #ed6a60;
			text-shadow: #000 1px 1px 5px;
		}

		.alert.current {
			background-color: #5e5ef3;
			text-shadow: #000 1px 1px 5px;
		}

		.alert.power {
			background-color: #619d65;
			text-shadow: #000 1px 1px 5px;
		}

		.closebtn {
			margin-left: 15px;
			color: white;
			font-weight: bold;
			float: right;
			font-size: 22px;
			line-height: 20px;
			cursor: pointer;
			transition: 0.3s;
			margin: -4px;
		}

		.closebtn:hover {
			color: #c1c1c1;
		}

		#alarmsConfig {
			border-radius: 10px;
			box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
			max-width: 100%;
			width: 100%;
			display: grid;
			grid-template-columns: repeat(3, 1fr);
		}

		.alarm-section {
			border: 2px solid;
			background-color: #382e26;
			padding: 20px;
			margin: 10px;
			border-radius: 10px;
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		.alarm-section h2 {
			margin-top: 0;
			font-size: 1.5em;
		}

		.output-config-box {
			border: 2px solid;
			background-color: #382e26;
			padding: 20px;
			margin: 10px;
			border-radius: 10px;
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		.input-group {
			display: flex;
			justify-content: center;
			align-items: center;
			margin-bottom: 10px;
			width: 100%;
		}

		.input-group label {
			margin-right: 10px;
			text-align: center;
		}

		.input-group input[type="number"] {
			max-width: 100px;
			padding: 5px;
			border-radius: 5px;
			border: 1px solid #e88504;
			background-color: black;
			color: white;
		}

		.input-group input[type="checkbox"] {
			margin-left: 10px;
			appearance: none;
			width: 20px;
			height: 20px;
			min-width: 20px;
			min-height: 20px;
			background: #333;
			border: 2px solid #ffa500;
			border-radius: 3px;
			position: relative;
		}

		.input-group input[type="checkbox"]:checked {
			background-color: #ffa500;
		}

		.input-group input[type="checkbox"]:checked::after {
			content: "";
			position: absolute;
			width: 5px;
			height: 10px;
			border: 2px solid #222;
			border-width: 0 2px 2px 0;
			transform: rotate(45deg);
			top: 1px;
			left: 5px;
		}

		@media screen and (max-width: 1020px) {
			.container {
				grid-template-columns: 1fr;
			}

			.wrapper {
				height: calc(100vh + 145rem);
			}

			#alarmsConfig {
				grid-template-columns: 1fr;
			}

			.input-group {
				flex-direction: row;
				justify-content: center;
			}

			.input-group label {
				text-align: center;
			}
		}

		@media screen and (max-width: 600px) {
			.container {
				grid-template-columns: 1fr;
			}

			.wrapper {
				height: calc(100vh + 60rem);
			}

			.tooltip {
				flex-direction: column;
			}

			.input-minutes,
			.button {
				margin: 5px 0;
				width: 100%;
			}

			#alarmsConfig {
				grid-template-columns: 1fr;
			}

			.input-group {
				flex-direction: row;
				justify-content: center;
			}

			.input-group label {
				text-align: center;
				margin-bottom: 0.5rem;
			}

			.tab button {
				height: 4rem;
			}
		}
	</style>
</head>

<body>
	<ul class="menu">
		<li><a href="/">Dashboard</a></li>
		<li><a href="/config">Network Settings</a></li>
	</ul>
	<div id="top-dashboard">
		<div class="dash-panel">
			<h1>VOLTAGE: <span class='voltageDisplay'></span> V</h1>
			<h1>CURRENT: <span class='currentDisplay'></span> A</h1>
			<h1>POWER: <span class='powerDisplay'></span> W</h1>
		</div>
	</div>
	<div id="indicatorVoltage" class="alert voltage" style="display:none; opacity: 0;">
		<span class="closebtn" onclick="this.parentElement.style.opacity='0'; setTimeout(() => {this.parentElement.style.display='none';		
		}, 600);">&times;</span>
		<strong>VOLTAGE ALARM!</strong> Indicates that Voltage Threshold is reached!
	</div>
	<div id="indicatorCurrent" class="alert current" style="display:none; opacity: 0;">
		<span class="closebtn" onclick="this.parentElement.style.opacity='0'; setTimeout(() => {this.parentElement.style.display='none';		
		}, 600);">&times;</span>
		<strong>CURRENT ALARM!</strong> Indicates that Current Threshold is reached!
	</div>
	<div id="indicatorPower" class="alert power" style="display:none; opacity: 0;">
		<span class="closebtn" onclick="this.parentElement.style.opacity='0'; setTimeout(() => {this.parentElement.style.display='none';		
		}, 600);">&times;</span>
		<strong>POWER ALARM!</strong> Indicates that Power Threshold is reached!
	</div>
	<div class="tab">
		<button class="tablinks" onclick="openTab(event, 'ChartDash')">All Charts</button>
		<button class="tablinks" onclick="openTab(event, 'ChartConfig')">Charts Configuration</button>
		<button class="tablinks" onclick="openTab(event, 'alarmsConfig')">Alarms</button>
		<button class="tablinks" onclick="openTab(event, 'psuControl')" id="defaultOpen">Control</button>
	</div>
	<div id="ChartDash" class="tabcontent">
		<div class="wrapper">
			<div class='container'>
				<div class='chart-box'>
					<h2>Voltage History</h2>
					<canvas id='voltageChart'></canvas>
					<br>
					<button class="button" onclick='exportPNGChart("voltageChart")'>Export PNG</button>
					<button class="button" onclick='exportCSVChart("voltageChart")'>Export CSV</button>
				</div>
				<div class='chart-box'>
					<h2>Current History</h2>
					<canvas id='currentChart'></canvas>
					<br>
					<button class="button" onclick='exportPNGChart("currentChart")'>Export PNG</button>
					<button class="button" onclick='exportCSVChart("currentChart")'>Export CSV</button>
				</div>
				<div class='chart-box'>
					<h2>Power History</h2>
					<canvas id='powerChart'></canvas>
					<br>
					<button class="button" onclick='exportPNGChart("powerChart")'>Export PNG</button>
					<button class="button" onclick='exportCSVChart("powerChart")'>Export CSV</button>
				</div>
			</div>
			<div class='container'>
				<div class='chart-box' style="grid-column: span 1;">
					<h2>Voltage and Current History</h2>
					<canvas id='combinedChart'></canvas>
					<br>
					<button class="button" onclick='exportPNGChart("combinedChart")'>Export PNG</button>
					<button class="button" onclick='exportCSVChart("combinedChart")'>Export CSV</button>
				</div>
				<div class='chart-box' style="grid-column: span 1;">
					<h2>Voltage, Current and Power History</h2>
					<canvas id='combinedChart2'></canvas>
					<br>
					<button class="button" onclick='exportPNGChart("combinedChart2")'>Export PNG</button>
					<button class="button" onclick='exportCSVChart("combinedChart2")'>Export CSV</button>
				</div>
			</div>
			<div id="bottom-bar">
				<div class="bottom-bar-element">
					<i class="bottom-bar-info">VOLTAGE</i><br>
					<span class='voltageDisplay' style='color: #e88504;'></span> V
				</div>
				<div class="bottom-bar-element">
					<i class="bottom-bar-info">CURRENT</i><br>
					<span class='currentDisplay' style='color: #e88504;'></span> A
				</div>
				<div class="bottom-bar-element">
					<i class="bottom-bar-info">POWER</i><br>
					<span class='powerDisplay' style='color: #e88504;'></span> W
				</div>
			</div>
		</div>
	</div>
	<div id="ChartConfig" class="tabcontent charts-config">
		<div class="charts-config-box">
			<div class="input-group" style="display: block;">
				<div class="tooltip">
					<label for="points">History Range (in Minutes):</label>
					<span class="tooltiptext">Set how many minutes to visualised in the History Charts.</span>
					<input class="input-minutes" type="number" id="points" value="1" min="1" max="100000">
				</div>
				<div class="tooltip">
					<label for="updateFrequency">Update Frequency (ms):</label>
					<span class="tooltiptext">Set the update frequency for History Charts in milliseconds. 1 minute =
						1000
						ms</span>
					<input class="input-minutes" type="number" id="updateFrequency" value="500" min="500">
				</div>
				<div class="tooltip">
					<button class="button chart-config" onclick="changePoints()">Save</button>
				</div>
			</div>
		</div>
	</div>
	<div id="alarmsConfig" class="tabcontent">
		<div class="alarm-section">
			<h2>Voltage Alarm</h2>
			<div class="input-group">
				<label for="thresholdVoltage">Voltage Threshold:</label>
				<input type="number" id="thresholdVoltage" value="3.3" step="0.1">
			</div>
			<div class="input-group">
				<label for="checkMoreVoltage">Beep when <b>Voltage</b> exceeds the threshold:</label>
				<input type="checkbox" id="checkMoreVoltage">
			</div>
			<div class="input-group">
				<label for="checkLessVoltage">Beep when <b>Voltage</b> falls below the threshold:</label>
				<input type="checkbox" id="checkLessVoltage">
			</div>
			<div class="input-group">
				<label for="beepCountVoltage">Number of Beeps:</label>
				<input type="number" id="beepCountVoltage" value="3">
			</div>
			<div class="input-group">
				<label for="activateVoltage">Activate Alarm:</label>
				<input type="checkbox" id="activateVoltage">
			</div>
		</div>
		<div class="alarm-section">
			<h2>Current Alarm</h2>
			<div class="input-group">
				<label for="thresholdCurrent">Current Threshold:</label>
				<input type="number" id="thresholdCurrent" value="2.0" step="0.1">
			</div>
			<div class="input-group">
				<label for="checkMoreCurrent">Beep when <b>Current</b> exceeds the threshold:</label>
				<input type="checkbox" id="checkMoreCurrent">
			</div>
			<div class="input-group">
				<label for="checkLessCurrent">Beep when <b>Current</b> falls below the threshold:</label>
				<input type="checkbox" id="checkLessCurrent">
			</div>
			<div class="input-group">
				<label for="beepCountCurrent">Number of Beeps:</label>
				<input type="number" id="beepCountCurrent" value="4">
			</div>
			<div class="input-group">
				<label for="activateCurrent">Activate Alarm:</label>
				<input type="checkbox" id="activateCurrent">
			</div>
		</div>
		<div class="alarm-section">
			<h2>Power Alarm</h2>
			<div class="input-group">
				<label for="thresholdPower">Power Threshold:</label>
				<input type="number" id="thresholdPower" value="5.0" step="0.1">
			</div>
			<div class="input-group">
				<label for="checkMorePower">Beep when <b>Power</b> exceeds the threshold:</label>
				<input type="checkbox" id="checkMorePower">
			</div>
			<div class="input-group">
				<label for="checkLessPower">Beep when <b>Power</b> falls below the threshold:</label>
				<input type="checkbox" id="checkLessPower">
			</div>
			<div class="input-group">
				<label for="beepCountPower">Number of Beeps:</label>
				<input type="number" id="beepCountPower" value="5">
			</div>
			<div class="input-group">
				<label for="activatePower">Activate Alarm:</label>
				<input type="checkbox" id="activatePower">
			</div>
		</div>
	</div>
	<div id="psuControl" class="tabcontent output-config">
		<div class="output-config-box">
			<h2>PSU Output Control</h2>
			<div class="input-group" style="display: block;">
				<div class="tooltip">
					<label for="lblPcMaster">Remote control : </label>
					<span class="tooltiptext">Enable the remote control of the PSU.</span>
					<input type="checkbox" id="remoteCtrlEnable" onclick="remoteMasterManager()">
				</div>
				<div class="tooltip">
					<label for="outVoltage">Voltage (V) : </label>
					<span class="tooltiptext">Set the maximum output voltage of the power supply.</span>
					<input class="voltage" type="number" id="outVoltage" value="0.0" min="0.0" max="1000.0" step="0.1">
				</div>
				<div class="tooltip">
					<label for="outCurrent">Current (A) : </label>
					<span class="tooltiptext">Set the maximum output current of the power supply.</span>
					<input class="input-outCurrent" type="number" id="outCurrent" value="0.0" min="0.0" max="1.1" step="0.1">
				</div>
				<div class="tooltip">
					<button id="btnApplyOutput" class="button output-config" onclick="newOutputValues()" disabled>Apply</button>
				</div>
				<div class="tooltip">
					<label for="lblOutEnable">Output enable : </label>
					<span class="tooltiptext">Enable the output of the PSU.</span>
					<input type="checkbox" id="outputCtrlEnable" onclick="psuOutputManager()" disabled>
				</div>
			</div>
		</div>
	</div>

	<script src='/chart.js'></script>
	<script>
		var maxDataPoints = 30 * 2; // *2 because we need to convert points to a second. Default value 30 equivalent to 30 seconds
		var updateFrequency = 500; // Default update frequency in milliseconds
		var updateInterval; // Variable to hold the interval ID

		var voltageHistory = [];
		var currentHistory = [];
		var powerHistory = [];
		var voltageChart, currentChart, combinedChart, powerChart, combinedChart2;
		// Open Default tab
		openDefaultTab();

		window.onload = function () {
			voltageChart = new Chart(document.getElementById('voltageChart').getContext('2d'), {
				type: 'line',
				data: {
					labels: [],
					datasets: [{
						label: 'V',
						data: [],
						borderColor: 'red',
						backgroundColor: 'red',
						borderWidth: 3,
						fill: false
					}]
				},
				options: {
					animation: false,
					pointRadius: 2,
					pointHoverRadius: 5,
					scales: {
						y: {
							display: true,
							//title: {
							//display: true,
							//text: 'Voltage'
							//}
						}
					}
				}
			});
			currentChart = new Chart(document.getElementById('currentChart').getContext('2d'), {
				type: 'line',
				data: {
					labels: [],
					datasets: [{
						label: 'A',
						data: [],
						borderColor: 'blue',
						backgroundColor: 'blue',
						borderWidth: 3,
						fill: false
					}]
				},
				options: {
					animation: false,
					pointRadius: 2,
					pointHoverRadius: 5,
					scales: {
						y: {
							display: true,
							//title: {
							//display: true,
							//text: 'Current'
							//}
						}
					}
				}
			});
			powerChart = new Chart(document.getElementById('powerChart').getContext('2d'), {
				type: 'line',
				data: {
					labels: [],
					datasets: [{
						label: 'W',
						data: [],
						borderColor: 'green',
						backgroundColor: 'green',
						borderWidth: 3,
						fill: false
					}]
				},
				options: {
					animation: false,
					pointRadius: 2,
					pointHoverRadius: 5,
					scales: {
						y: {
							display: true,
							//title: {
							//display: true,
							//text: 'Watts'
							//}
						}
					}
				}
			});
			combinedChart = new Chart(document.getElementById('combinedChart').getContext('2d'), {
				type: 'line',
				data: {
					labels: [],
					datasets: [{
						label: 'V',
						data: [],
						borderColor: 'red',
						backgroundColor: 'red',
						borderWidth: 3,
						fill: false
					}, {
						label: 'A',
						data: [],
						borderColor: 'blue',
						backgroundColor: 'blue',
						borderWidth: 3,
						fill: false
					}]
				},
				options: {
					animation: false,
					pointRadius: 2,
					pointHoverRadius: 5,
					scales: {
						y: {
							display: true,
							//title: {
							//display: true,
							//text: 'Voltage, Current'
							//}
						}
					}
				}
			});
			combinedChart2 = new Chart(document.getElementById('combinedChart2').getContext('2d'), {
				type: 'line',
				data: {
					labels: [],
					datasets: [{
						label: 'V',
						data: [],
						borderColor: 'red',
						backgroundColor: 'red',
						borderWidth: 3,
						fill: false
					}, {
						label: 'A',
						data: [],
						borderColor: 'blue',
						backgroundColor: 'blue',
						borderWidth: 3,
						fill: false
					}, {
						label: 'W',
						data: [],
						borderColor: 'green',
						backgroundColor: 'green',
						borderWidth: 3,
						fill: false
					}]
				},
				options: {
					animation: false,
					pointRadius: 2,
					pointHoverRadius: 5,
					scales: {
						y: {
							display: true,
							//title: {
							//display: true,
							//text: 'Voltage, Current, Watts'
							//}
						}
					}
				}
			});
			startFetchingData(); // Start fetching data with the default update frequency
		};

		function fetchDataAndUpdateCharts() {
			fetch('/data')
				.then(response => response.json())
				.then(data => {
					const voltageElements = document.getElementsByClassName('voltageDisplay');
					const currentElements = document.getElementsByClassName('currentDisplay');
					const powerElements = document.getElementsByClassName('powerDisplay');
					// Update text content for voltage elements
					for (const element of voltageElements) {
						element.textContent = data.voltage.toFixed(2);
						// Set voltage for alarm threshold
						voltage.value = data.voltage.toFixed(2);
					}
					// Update text content for current elements
					for (const element of currentElements) {
						element.textContent = data.current.toFixed(3);
						// Set current for alarm threshold
						current.value = data.current.toFixed(3);
					}
					// Update text content for power elements
					for (const element of powerElements) {
						element.textContent = data.power.toFixed(3);
						// Set power for alarm threshold
						power.value = data.power.toFixed(3);
					}
					voltageHistory.push(data.voltage.toFixed(2));
					currentHistory.push(data.current);
					powerHistory.push(data.power);
					if (voltageHistory.length > maxDataPoints) voltageHistory.shift();
					if (currentHistory.length > maxDataPoints) currentHistory.shift();
					if (powerHistory.length > maxDataPoints) powerHistory.shift();
					voltageChart.data.labels = [...Array(voltageHistory.length).keys()];
					voltageChart.data.datasets[0].data = voltageHistory;
					voltageChart.update();
					currentChart.data.labels = [...Array(currentHistory.length).keys()];
					currentChart.data.datasets[0].data = currentHistory;
					currentChart.update();
					combinedChart.data.labels = [...Array(Math.max(voltageHistory.length, currentHistory.length)).keys()];
					combinedChart.data.datasets[0].data = voltageHistory;
					combinedChart.data.datasets[1].data = currentHistory;
					combinedChart.update();
					powerChart.data.labels = [...Array(powerHistory.length).keys()];
					powerChart.data.datasets[0].data = powerHistory;
					powerChart.update();
					combinedChart2.data.labels = [...Array(Math.max(voltageHistory.length, currentHistory.length, powerHistory.length)).keys()];
					combinedChart2.data.datasets[0].data = voltageHistory;
					combinedChart2.data.datasets[1].data = currentHistory;
					combinedChart2.data.datasets[2].data = powerHistory;
					combinedChart2.update();
				});
		}

		function startFetchingData() {
			clearInterval(updateInterval); // Clear any existing interval
			updateInterval = setInterval(fetchDataAndUpdateCharts, updateFrequency);
		}

		function changeUpdateFrequency() {
			var frequency = parseInt(document.getElementById('updateFrequency').value);
			if (isNaN(frequency) || frequency < 500) {
				alert("Please enter a valid positive number more then 500ms.");
				return;
			}
			updateFrequency = frequency;
			startFetchingData(); // Restart the interval with the new frequency
		}

		function getFormattedDateTime() {
			var currentDate = new Date();
			var day = currentDate.getDate();
			var month = currentDate.getMonth() + 1; // January is 0
			var year = currentDate.getFullYear();
			var hours = currentDate.getHours();
			var minutes = currentDate.getMinutes();
			var seconds = currentDate.getSeconds();

			// Formatting with leading zeros if necessary and the desired order
			var formattedDateTime = [
				day < 10 ? '0' + day : day,
				month < 10 ? '0' + month : month,
				year,
				hours < 10 ? '0' + hours : hours,
				minutes < 10 ? '0' + minutes : minutes,
				seconds < 10 ? '0' + seconds : seconds
			].join('_');

			return formattedDateTime;
		}

		function exportPNGChart(chartId) {
			var chartCanvas = document.getElementById(chartId);
			var dataURL = chartCanvas.toDataURL('image/png');
			var fileName = chartId + '_' + getFormattedDateTime() + '.png';
			var link = document.createElement('a');
			link.href = dataURL;
			link.download = fileName;
			link.click();
		}

		function exportCSVChart(chartId) {
			// Get the Chart.js instance
			var chartInstance = Chart.getChart(chartId);
			// Extract data from the chart instance
			var chartData = chartInstance.data;
			// Extract labels and datasets from the chart data
			var labels = chartData.labels;
			var datasets = chartData.datasets;
			// Prepare CSV content
			var csvContent = "data:text/csv;charset=utf-8,";
			// Add headers for Point and selected data based on chartId
			csvContent += "Point,";
			var includeVoltage = false;
			var includeCurrent = false;
			var includePower = false;

			if (chartId === "combinedChart" || chartId === "combinedChart2") {
				datasets.forEach(function (dataset) {
					if (dataset.label === "V") {
						csvContent += "Voltage,";
						includeVoltage = true;
					} else if (dataset.label === "A") {
						csvContent += "Current,";
						includeCurrent = true;
					} else if (dataset.label === "W") {
						csvContent += "Power";
						includePower = true;
					}
				});
			} else {
				// Handle individual charts
				if (chartId === "voltageChart") {
					csvContent += "Voltage";
					includeVoltage = true;
				} else if (chartId === "currentChart") {
					csvContent += "Current";
					includeCurrent = true;
				} else if (chartId === "powerChart") {
					csvContent += "Power";
					includePower = true;
				}
			}
			csvContent += "\n";

			// Add data from datasets to CSV
			for (var i = 0; i < labels.length; i++) {
				var row = (i + 1) + ",";
				if (includeVoltage) {
					row += datasets.find(dataset => dataset.label === "V").data[i];
					if (includeCurrent || includePower) row += ",";
				}
				if (includeCurrent) {
					row += datasets.find(dataset => dataset.label === "A").data[i];
					if (includePower) row += ",";
				}
				if (includePower) {
					row += datasets.find(dataset => dataset.label === "W").data[i];
				}
				csvContent += row + "\n";
			}

			// Create a download link
			var encodedUri = encodeURI(csvContent);
			var link = document.createElement("a");
			link.setAttribute("href", encodedUri);
			link.setAttribute("download", chartId + "_data_" + getFormattedDateTime() + ".csv");
			// Simulate click to trigger download
			link.click();
		}

		function changePoints() {
			changeUpdateFrequency();
			var points = parseInt(document.getElementById('points').value);
			if (isNaN(points) || points <= 0) {
				alert("Please enter a valid positive number.");
				return;
			}
			maxDataPoints = points * (1000 / updateFrequency) * 60; // Adjust for new update frequency
			// Update the number of points for the charts
			while (voltageHistory.length > points) voltageHistory.shift();
			while (currentHistory.length > points) currentHistory.shift();
			while (powerHistory.length > points) powerHistory.shift();
			// Clear the labels and data for each chart
			voltageChart.data.labels = [...Array(voltageHistory.length).keys()];
			voltageChart.data.datasets[0].data = voltageHistory;
			currentChart.data.labels = [...Array(currentHistory.length).keys()];
			currentChart.data.datasets[0].data = currentHistory;
			combinedChart.data.labels = [...Array(Math.max(voltageHistory.length, currentHistory.length)).keys()];
			combinedChart.data.datasets[0].data = voltageHistory;
			combinedChart.data.datasets[1].data = currentHistory;
			powerChart.data.labels = [...Array(powerHistory.length).keys()];
			powerChart.data.datasets[0].data = powerHistory;
			combinedChart2.data.labels = [...Array(Math.max(voltageHistory.length, currentHistory.length, powerHistory.length)).keys()];
			combinedChart2.data.datasets[0].data = voltageHistory;
			combinedChart2.data.datasets[1].data = currentHistory;
			combinedChart2.data.datasets[2].data = powerHistory;
			// Update the charts
			voltageChart.update();
			currentChart.update();
			combinedChart.update();
			powerChart.update();
			combinedChart2.update();
			// Open Default tab
			openDefaultTab();
		}
		
		function newOutputValues(){
			var newOutVoltage = parseFloat(document.getElementById('outVoltage').value);
			var newOutCurrent = parseFloat(document.getElementById('outCurrent').value);
			if (isNaN(newOutVoltage) || newOutVoltage <= 0) {
				alert("Please enter a valid positive number.");
				return;
			}
			if (isNaN(newOutCurrent) || newOutCurrent <= 0) {
				alert("Please enter a valid positive number.");
				return;
			}
			
			// Update the number of points for the charts
			pushControlData(newOutVoltage, newOutCurrent);
		}

		function pushControlData(voltage, current) {
			fetch('/setoutput', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					voltage: voltage,
					current: current
				})
			})
			.then(response => {
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}
				return response.json();
			})
			.then(data => {
				console.log('Control data pushed:', data);
			})
			.catch(error => {
				console.error('Error pushing control data:', error);
			});
		}
		
		function remoteMasterManager(){
			const button = document.getElementById('btnApplyOutput');
			button.disabled = !remoteCtrlEnable.checked; // Enable button if checkbox is checked
			outputCtrlEnable.disabled = !remoteCtrlEnable.checked; // Enable checkbox if checkbox is checked
			if(!remoteCtrlEnable.checked){
				outputCtrlEnable.checked = false;
				psuOutputManager();
			}
			pushRemoteControlEnable(remoteCtrlEnable.checked);
		}
		
		function psuOutputManager(){
			pushPsuOutputEnable(outputCtrlEnable.checked);
		}
		
		function pushRemoteControlEnable(bEnable){
			fetch(uri, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					remoteIsMaster: bEnable
				})
			})
			.then(response => {
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}
				return response.json();
			})
			.then(data => {
				console.log('Control data pushed:', data);
			})
			.catch(error => {
				console.error('Error pushing control data:', error);
			});
		}
		
		function pushPsuOutputEnable(bEnable){
			fetch(uri, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					outputIsEnabled: bEnable
				})
			})
			.then(response => {
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}
				return response.json();
			})
			.then(data => {
				console.log('Control data pushed:', data);
			})
			.catch(error => {
				console.error('Error pushing control data:', error);
			});
		}
		
		// Show bottom bar when scrolled down, hide when scrolled up and top-dashboard is visible
		var lastScrollTop = 0;
		var bottomBar = document.getElementById('bottom-bar');
		var topDashboard = document.getElementById('top-dashboard');
		window.addEventListener('scroll', function () {
			var currentScroll = window.pageYOffset || document.documentElement.scrollTop;
			var topDashboardRect = topDashboard.getBoundingClientRect();
			if (currentScroll > lastScrollTop && topDashboardRect.bottom <= 0) {
				// Scroll down and top dashboard is entirely hidden
				bottomBar.style.visibility = 'visible';
				bottomBar.style.opacity = 1;
			} else if (currentScroll < lastScrollTop && topDashboardRect.bottom > 0) {
				// Scroll up and top dashboard is visible
				bottomBar.style.visibility = 'hidden';
				bottomBar.style.opacity = 0;
			}
			lastScrollTop = currentScroll;
		});

		function openTab(evt, tabName) {
			var i, tabcontent, tablinks;
			tabcontent = document.getElementsByClassName("tabcontent");
			for (i = 0; i < tabcontent.length; i++) {
				tabcontent[i].style.display = "none";
			}
			tablinks = document.getElementsByClassName("tablinks");
			for (i = 0; i < tablinks.length; i++) {
				tablinks[i].className = tablinks[i].className.replace(" active", "");
			}
			document.getElementById(tabName).style.display = "";
			evt.currentTarget.className += " active";
		}

		function openDefaultTab() {
			// Get the element with id="defaultOpen" and click on it
			document.getElementById("defaultOpen").click();
		}

		let beeping = false;
		let beepInterval;

		const beepFlags = {
			voltage: false,
			current: false,
			power: false
		};

		const observable = (value, callback) => {
			return {
				get value() {
					return value;
				},
				set value(newValue) {
					value = newValue;
					callback(newValue);
				}
			};
		};

		let voltage = observable(0, (newValue) => {
			checkValues(
				document.getElementById('thresholdVoltage'),
				newValue,
				document.getElementById('activateVoltage'),
				document.getElementById('checkMoreVoltage'),
				document.getElementById('checkLessVoltage'),
				document.getElementById('beepCountVoltage'),
				'indicatorVoltage',
				'voltage'
			);
		});

		let current = observable(0, (newValue) => {
			checkValues(
				document.getElementById('thresholdCurrent'),
				newValue,
				document.getElementById('activateCurrent'),
				document.getElementById('checkMoreCurrent'),
				document.getElementById('checkLessCurrent'),
				document.getElementById('beepCountCurrent'),
				'indicatorCurrent',
				'current'
			);
		});

		let power = observable(0, (newValue) => {
			checkValues(
				document.getElementById('thresholdPower'),
				newValue,
				document.getElementById('activatePower'),
				document.getElementById('checkMorePower'),
				document.getElementById('checkLessPower'),
				document.getElementById('beepCountPower'),
				'indicatorPower',
				'power'
			);
		});

		function checkValues(threshold, value, activateCheckbox, checkMoreCheckbox, checkLessCheckbox, beepCountInput, indicator, type) {
			if (beeping) return;

			const thresholdValue = parseFloat(threshold.value);
			const activate = activateCheckbox.checked;
			const checkMore = checkMoreCheckbox.checked;
			const checkLess = checkLessCheckbox.checked;
			const beepCount = parseInt(beepCountInput.value, 10);

			if (activate && ((checkMore && value > thresholdValue && !beepFlags[type]) || (checkLess && value < thresholdValue && !beepFlags[type]))) {
				beepFlags[type] = true;
				startBeeping(value, thresholdValue, beepCount, indicator);
			} else if (activate && !((checkMore && value > thresholdValue) || (checkLess && value < thresholdValue))) {
				beepFlags[type] = false;
			}
		}

		function beep() {
			var sound = new Audio("data:audio/wav;base64,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qJrx4KOQjahZxWbcZgztj2c49nKmkId44S71j0c8eV9yDK6uPRzx5X18eDvjvQ6yKo9ZSS6l//8elePK/Lf//IInrOF/FvDoADYAGBMGb7FtErm5MXMlmPAJQVgWta7Zx2go+8xJ0UiCb8LHHdftWyLJE0QIAIsI+UbXu67dZMjmgDGCGl1H+vpF4NSDckSIkk7Vd+sxEhBQMRU8j/12UIRhzSaUdQ+rQU5kGeFxm+hb1oh6pWWmv3uvmReDl0UnvtapVaIzo1jZbf/pD6ElLqSX+rUmOQNpJFa/r+sa4e/pBlAABoAAAAA3CUgShLdGIxsY7AUABPRrgCABdDuQ5GC7DqPQCgbbJUAoRSUj+NIEig0YfyWUho1VBBBA//uQZB4ABZx5zfMakeAAAAmwAAAAF5F3P0w9GtAAACfAAAAAwLhMDmAYWMgVEG1U0FIGCBgXBXAtfMH10000EEEEEECUBYln03TTTdNBDZopopYvrTTdNa325mImNg3TTPV9q3pmY0xoO6bv3r00y+IDGid/9aaaZTGMuj9mpu9Mpio1dXrr5HERTZSmqU36A3CumzN/9Robv/Xx4v9ijkSRSNLQhAWumap82WRSBUqXStV/YcS+XVLnSS+WLDroqArFkMEsAS+eWmrUzrO0oEmE40RlMZ5+ODIkAyKAGUwZ3mVKmcamcJnMW26MRPgUw6j+LkhyHGVGYjSUUKNpuJUQoOIAyDvEyG8S5yfK6dhZc0Tx1KI/gviKL6qvvFs1+bWtaz58uUNnryq6kt5RzOCkPWlVqVX2a/EEBUdU1KrXLf40GoiiFXK///qpoiDXrOgqDR38JB0bw7SoL+ZB9o1RCkQjQ2CBYZKd/+VJxZRRZlqSkKiws0WFxUyCwsKiMy7hUVFhIaCrNQsKkTIsLivwKKigsj8XYlwt/WKi2N4d//uQRCSAAjURNIHpMZBGYiaQPSYyAAABLAAAAAAAACWAAAAApUF/Mg+0aohSIRobBAsMlO//Kk4soosy1JSFRYWaLC4qZBYWFRGZdwqKiwkNBVmoWFSJkWFxX4FFRQWR+LsS4W/rFRb/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////VEFHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAU291bmRib3kuZGUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMjAwNGh0dHA6Ly93d3cuc291bmRib3kuZGUAAAAAAAAAACU=");
			sound.play();
		}

		function startBeeping(value, threshold, beepCount, indicator) {
			beeping = true;
			let indicatorElem = document.getElementById(indicator);
			indicatorElem.style.display = 'block';
			setTimeout(() => {
				indicatorElem.style.opacity = 1;
			}, 300);

			let count = 0;
			beepInterval = setInterval(() => {
				if (count >= beepCount) {
					stopBeeping(indicator);
				} else {
					beep();
					count++;
				}
			}, 350);
		}

		function stopBeeping(indicator) {
			beeping = false;
			clearInterval(beepInterval);
		}

		function addEventListeners(thresholdId, activateId, checkMoreId, checkLessId, beepCountId, valueObservable, type) {
			const threshold = document.getElementById(thresholdId);
			const activateCheckbox = document.getElementById(activateId);
			const checkMoreCheckbox = document.getElementById(checkMoreId);
			const checkLessCheckbox = document.getElementById(checkLessId);
			const beepCountInput = document.getElementById(beepCountId);

			const check = () => {
				checkValues(threshold, valueObservable.value, activateCheckbox, checkMoreCheckbox, checkLessCheckbox, beepCountInput, `indicator${thresholdId.replace('threshold', '')}`, type);
			};

			threshold.addEventListener('input', check);
			activateCheckbox.addEventListener('change', check);
			checkMoreCheckbox.addEventListener('change', check);
			checkLessCheckbox.addEventListener('change', check);
			beepCountInput.addEventListener('input', check);
		}

		addEventListeners('thresholdVoltage', 'activateVoltage', 'checkMoreVoltage', 'checkLessVoltage', 'beepCountVoltage', voltage, 'voltage');
		addEventListeners('thresholdCurrent', 'activateCurrent', 'checkMoreCurrent', 'checkLessCurrent', 'beepCountCurrent', current, 'current');
		addEventListeners('thresholdPower', 'activatePower', 'checkMorePower', 'checkLessPower', 'beepCountPower', power, 'power');
	</script>
</body>

</html>